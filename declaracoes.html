<!DOCTYPE html>
<html>
<head>
    <title>Customizable Text Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #inputArea, #customizationArea, #outputArea {
            margin-bottom: 20px;
        }
        input, button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
        }
        #fieldsContainer {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="patternInputArea">
        <input type="text" id="declarationTitle" placeholder="Título (ex: declaração para monitoria)">
        <input type="text" id="fullName" placeholder="Nome Completo">
        <input type="text" id="city" placeholder="Fortaleza, DD de MM de 20AA">
        <input type="text" id="role" placeholder="Cargo no Comitê Local e nome do Comitê">
    </div>

    <textarea id="textEditor" rows="10" cols="50"></textarea>

    <div id="tagInputArea">
        <input type="text" id="tagName" placeholder="Tag name">
        <button id="addTagButton">Adicione área customizável</button>
    </div>

    <div id="peopleCustomizationArea">
        <input type="number" id="peopleCount" placeholder="Number of people">
        <button id="createFieldsButton">Criar campos</button>
    </div>

    <div id="fieldsContainer"></div>

    <button id="generateFinalTextButton">Gerar texto final</button>

    <div id="finalTextOutput"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.25.1/docxtemplater.min.js"></script>
    <script>

document.getElementById('addTagButton').addEventListener('click', function() {
    let tagName = document.getElementById('tagName').value;
    let textEditor = document.getElementById('textEditor');
    let cursorPos = textEditor.selectionStart;
    let textBefore = textEditor.value.substring(0, cursorPos);
    let textAfter = textEditor.value.substring(cursorPos);
    textEditor.value = textBefore + `{${tagName}}` + textAfter;
});

document.getElementById('createFieldsButton').addEventListener('click', function() {
    let peopleCount = document.getElementById('peopleCount').value;
    let fieldsContainer = document.getElementById('fieldsContainer');
    fieldsContainer.innerHTML = ''; // Clear existing fields

    for (let i = 0; i < peopleCount; i++) {
        let personFields = document.createElement('div');
        personFields.innerHTML = `<h3>Person ${i + 1}</h3>`;
        let tagNames = document.getElementById('textEditor').value.match(/\{([^}]+)\}/g);

        if (tagNames) {
            tagNames.forEach(tagName => {
                let fieldName = tagName.replace(/[{}]/g, '') + `_${i}`;
                personFields.innerHTML += `<label>${fieldName}: </label><input type='text' name='${fieldName}'><br>`;
            });
        }

        fieldsContainer.appendChild(personFields);
    }
});

document.getElementById('generateFinalTextButton').addEventListener('click', function() {
    let originalText = document.getElementById('textEditor').value;
    let peopleCount = document.getElementById('peopleCount').value;
    let finalTextOutput = document.getElementById('finalTextOutput');
    finalTextOutput.innerHTML = ''; // Clear existing output

    for (let i = 0; i < peopleCount; i++) {
        let finalText = originalText;
        let fields = document.querySelectorAll(`#fieldsContainer div:nth-child(${i + 1}) input`);
        
        fields.forEach(field => {
            let regex = new RegExp(`\\{${field.name.split('_')[0]}\\}`, 'g');
            finalText = finalText.replace(regex, field.value);
        });

        finalTextOutput.innerHTML += `<h3>Person ${i + 1}</h3><p>${finalText}</p>`;
    }
});

        document.getElementById('generateFinalTextButton').addEventListener('click', function() {
            let originalText = document.getElementById('textEditor').value;
            let peopleCount = document.getElementById('peopleCount').value;
            let finalTextOutput = document.getElementById('finalTextOutput');
            finalTextOutput.innerHTML = ''; // Clear existing output

            for (let i = 0; i < peopleCount; i++) {
                let finalText = originalText;
                let fields = document.querySelectorAll(`#fieldsContainer div:nth-child(${i + 1}) input`);
                
                fields.forEach(field => {
                    let regex = new RegExp(`\\{${field.name.split('_')[0]}\\}`, 'g');
                    finalText = finalText.replace(regex, field.value);
                });

                // Append the customized text for each person
                finalTextOutput.innerHTML += `<h3>Person ${i + 1}</h3><p>${finalText}</p>`;

                // Create a download link for each person's customized docx file
                let downloadLink = document.createElement("button");
                downloadLink.innerText = "Download Person " + (i + 1) + " Document";
                downloadLink.onclick = function() {
                    loadAndModifyDocx(finalText, i);
                };
                finalTextOutput.appendChild(downloadLink);
            }
        });

        function loadAndModifyDocx(newText, personIndex) {
            let url = 'declaracoes/template.docx';
            // Fetch the .docx file from the server
            fetch(url)
            .then(response => response.blob())
            .then(blob => {
                // ... [Rest of your existing fetch and JSZip code] ...

                // Modify the XML content
                let updatedXml = xml
                    .replace('{TÍTULO}', document.getElementById('declarationTitle').value)
                    .replace('{NAME}', document.getElementById('fullName').value)
                    .replace('{CITY}', document.getElementById('city').value)
                    .replace('{ROLE}', document.getElementById('role').value)
                    .replace('{TEXT}', newText);

                // ... [Rest of your existing zip and download code] ...

                // Set the filename to include the person index
                a.download = "modified_person_" + (personIndex + 1) + ".docx";
            });
        }
    </script>
</body>
</html>
